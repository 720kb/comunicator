/*
 * comunicator - v0.0.2
 *
 * The 720kb notifier api (atm it uses websockets)
 * 2015-04-09
 */


!function(a){"use strict";var b=function(b){this.initComunicator=function(b){if(!b)throw"Please provide a valid URL.";this.websocket=new a.WebSocket(b),this.websocket.onopen=function(){a.console.info("Trasport",this,"opened.")},this.websocket.push=this.websocket.send},this.timeWaitSlice=64,this.timeWaitSliceChoices=[0],this.chosenTimeWaitValue=0,this.sendPendingRequests=[],this.joinPendingRequests=[],this.giveMeATimeWait=function(){return Math.floor(Math.random()*(this.timeWaitSliceChoices.length+1))},this.initComunicator(b)};b.prototype.promise=function(b){if(!this.websocket)throw"Mandatory field comunicatorServerURL required";if(b&&Array.isArray(b))return new Promise(function(c){var d,e,f=b.length,g=function q(b,c){var d,e;this.chosenTimeWaitValue>0&&this.websocket.readyState!==a.WebSocket.OPEN?(this.chosenTimeWaitValue-=1,a.console.debug("Decreasing chosen time wait value..."),d=a.requestAnimationFrame(q.bind(this,b,c)),"send"===c?this.sendPendingRequests.push(d):this.joinPendingRequests.push(d)):(e=this.timeWaitSlice*(Math.pow(2,this.timeWaitSliceChoices.length)-1),this.timeWaitSliceChoices.push(e),this.chosenTimeWaitValue=this.giveMeATimeWait(),a.console.debug("Chosen time wait value:",this.chosenTimeWaitValue),b())},h=function(b){var c,d=a.JSON.parse(b.data);if("joined"===d.opcode?c=new a.CustomEvent("comunicator:joined"):"sent"===d.opcode?c=new a.CustomEvent("comunicator:toMe",{detail:d}):"broadcasted"===d.opcode&&(c=new a.CustomEvent("comunicator:toAll",{detail:d})),!c)throw"Operation code from comunicator not reconized";a.dispatchEvent(c)},i=function(){this.whoReallyAmI&&this.reallyToken&&(a.dispatchEvent(new a.CustomEvent("comunicator:closed")),k())},j=function(b,c){var d,e,f,h=g.bind(this,j.bind(this,b,c),"send"),i=0;if(this.websocket.readyState===a.WebSocket.OPEN){for(this.websocket.push(JSON.stringify({opcode:b,token:this.reallyToken,data:c})),i=0,e=this.sendPendingRequests.length;e>i;i+=1)f=this.sendPendingRequests[i],a.cancelAnimationFrame(f);this.sendPendingRequests=[]}else a.console.debug("Trasport to server is not ready. Delay sending..."),d=a.requestAnimationFrame(h),this.sendPendingRequests.push(d)},k=function r(){var b,c,d,e=g.bind(this,r,"join"),f=0;if(this.websocket.readyState===a.WebSocket.OPEN){for(this.websocket.push(JSON.stringify({opcode:"join",whoami:this.whoReallyAmI,token:this.reallyToken})),f=0,c=this.joinPendingRequests.length;c>f;f+=1)d=this.joinPendingRequests[f],a.cancelAnimationFrame(d);this.joinPendingRequests=[]}else this.websocket.readyState===a.WebSocket.CONNECTING?(a.console.info("Trasport to server is not yet ready. Delay joining..."),b=a.requestAnimationFrame(e),this.joinPendingRequests.push(b)):(a.console.info("Trasport to server is down by now. Delay joining..."),this.initComunicator(this.websocket.url),this.websocket.send=j,this.websocket.onmessage=h,this.websocket.onclose=i,b=a.requestAnimationFrame(e),this.joinPendingRequests.push(b))},l=function(a,b){if(this.whoReallyAmI=a,this.reallyToken=b,!this.whoReallyAmI||!this.reallyToken)throw"User identification datas missing.";k()},m=function(a){if(!this.whoReallyAmI||!this.websocket)throw"User identification required";var b={whoami:this.whoReallyAmI,who:"*",what:a};this.websocket.send("broadcast",b)},n=function(a,b){if(!this.whoReallyAmI||!this.websocket)throw"User identification required";var c={whoami:this.whoReallyAmI,who:a,what:b};this.websocket.send("sendTo",c)},o=function(){this.websocket.readyState===a.WebSocket.OPEN&&this.websocket.close()},p=function s(){for(d=0;f>d;d+=1)e=b[d],e&&a.removeEventListener(e,s,!1);c({userIsPresent:l,broadcast:m,sendTo:n,exit:o})};for(d=0;f>d;d+=1)e=b[d],e&&a.addEventListener(e,p,!1);this.websocket.send=j,this.websocket.onmessage=h,this.websocket.onclose=i});throw"events must be defined and must be an array"},a.Comunicator=b}(window),function(a){"use strict";for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;d+=1)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(b){a.clearTimeout(b)})}(window);
//# sourceMappingURL=comunicator-min.js.map