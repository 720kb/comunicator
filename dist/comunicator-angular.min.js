/*
 * comunicator - v0.0.1
 *
 * The 720kb notifier api (atm it uses websockets)
 * 2015-03-12
 */


!function(a,b){"use strict";a.module("720kb.comunicator",[]).provider("Comunicator",function(){var a,c,d=64,e=[0],f=function(){return Math.floor(Math.random()*(e.length+1))},g=function(c){c?(a=new b.WebSocket(c),a.onopen=function(){b.console.info("Trasport",this,"opened.")}):b.console.error("Please provide a valid URL."),a.push=a.send};return{setComunicatorServerURL:g,$get:["$window","$rootScope","$timeout","$log","$q",function(b,h,i,j,k){c=k.defer();for(var l,m,n,o,p,q=0,r=[],s=[],t=function H(c,g){if(q>0&&a.readyState!==b.WebSocket.OPEN){q-=1;var h=b.requestAnimationFrame(H.bind(this,c,g));"send"===g?r.push(h):s.push(h)}else o=d*(Math.pow(2,e.length)-1),e.push(o),q=f(),c()},u=function(a){var b=JSON.parse(a.data);"joined"===b.opcode?h.$emit("comunicator:joined"):"sent"===b.opcode?h.$emit("comunicator:toMe",b):"broadcasted"===b.opcode&&h.$emit("comunicator:toAll",b)},v=function(){m&&n&&(h.$emit("comunicator:closed"),x())},w=function(c,d){var e,f,g,h=t.bind(this,w.bind(this,c,d),"send"),i=0;if(a.readyState===b.WebSocket.OPEN){for(a.push(JSON.stringify({opcode:c,token:n,data:d})),i=0,f=r.length;f>i;i+=1)g=r[i],b.cancelAnimationFrame(g);r=[]}else j.info("Trasport to server is not ready. Delay sending..."),e=b.requestAnimationFrame(h),r.push(e)},x=function I(){var c,d,e,f=t.bind(this,I,"join"),h=0;if(a.readyState===b.WebSocket.OPEN){for(a.push(JSON.stringify({opcode:"join",whoami:m,token:n})),h=0,d=s.length;d>h;h+=1)e=s[h],b.cancelAnimationFrame(e);s=[]}else a.readyState===b.WebSocket.CONNECTING?(j.info("Trasport to server is not yet ready. Delay joining..."),c=b.requestAnimationFrame(f),s.push(c)):(j.info("Trasport to server is down by now. Delay joining..."),g(a.url),a.send=w,a.onmessage=u,a.onclose=v,c=b.requestAnimationFrame(f),s.push(c))},y=function(a,b){m=a,n=b,m&&n?x():j.error("User identification datas missing.")},z=function(b){if(m&&a){var c={whoami:m,who:"*",what:b};a.send("broadcast",c)}else j.error("User identification required")},A=function(b,c){if(m&&a){var d={whoami:m,who:b,what:c};a.send("sendTo",d)}else j.error("User identification required")},B=function(){a.readyState===b.WebSocket.OPEN&&a.close()},C=["$stateChangeSuccess","$routeChangeSuccess"],D=[],E=C.length,F=0,G=function(){for(var a=0,b=D.length;b>a;a+=1)D[a]();c.resolve({userIsPresent:y,broadcast:z,sendTo:A,exit:B})};E>F;F+=1)p=C[F],D.push(h.$on(p,G));return a||(l="Mandatory field comunicatorServerURL required",j.error(l,a),c.reject(l)),a.send=w,a.onmessage=u,a.onclose=v,c.promise}]}})}(angular,window),function(a){"use strict";for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;d+=1)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(b){a.clearTimeout(b)})}(window);
//# sourceMappingURL=comunicator-angular.min.js.map