!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("rxjs/Rx"),require("ws")):"function"==typeof define&&define.amd?define("comunicator",["rxjs/Rx","ws"],t):e.comunicator=t(e.Rx,e.WebSocket)}(this,function(e,t){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t;var o={};o["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o.createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),o.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},o.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};var r=void 0;try{r=t,r||(r=window.WebSocket)}catch(n){r=window.WebSocket}var i=Symbol("whoReallyAmI"),a=Symbol("reallyToken"),s=Symbol("websocket"),u=Symbol("queue"),c=9e3,f=[0],h=function(){return Math.floor(Math.random()*(f.length+1))},l=function(t){function n(t){if(o.classCallCheck(this,n),!t)throw new Error("Mandatory parameter is missing: [websocketUrl] "+t);var i=new e.Observable(function(e){var n=!1;if(!l[s]||l[s].readyState===r.CONNECTING&&l[s].readyState===r.OPEN||(n=!0),"string"==typeof t)l[s]=new r(t);else{if(!("object"===("undefined"==typeof t?"undefined":o["typeof"](t))&&t instanceof r))throw new Error("websocket parameter passed is neither a string nor a WebSocket object");l[s]=t}return l[s].onopen=function(t){for(e.next({type:"open",whoami:t.target});l[u].length>0&&l[s].readyState===r.OPEN;)l[s].push(l[u].shift())},l[s].onmessage=function(t){var o=JSON.parse(t.data);"joined"===o.opcode?e.next({type:"joined",whoami:o.whoami}):"to-me"===o.opcode?e.next({type:"to-me",whoami:o.whoami,who:o.who,what:o.what}):"to-all"===o.opcode&&e.next({type:"to-all",whoami:o.whoami,what:o.what})},l[s].onerror=function(t){e.error({type:"error",cause:t})},l[s].onclose=function(){e.error({type:"closed"})},l[s].push=l[s].send,l[s].send=function(e,t){var o=JSON.stringify({opcode:e,token:l[a],data:t});l[s]&&l[s].readyState===r.OPEN?l[s].push(o):l[u].push(o)},n&&l[s].readyState!==r.CONNECTING&&l[s].readyState!==r.OPEN&&e.error({type:"closed"}),function(){l[s].close()}}).share(),l=o.possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,function(t){var o=i.retryWhen(function(t){return t.switchMap(function(){var t=c*(Math.pow(2,f.length)-1);return f.push(t),e.Observable.timer(f[h()])})}).subscribe(t);return function(){o.unsubscribe()}}));return l[u]=[],l}return o.inherits(n,t),o.createClass(n,[{key:"userIsPresent",value:function(e,t){if(this[i]===e&&this[a]===t)throw new Error("User is already identified.");if(!e||!t)throw new Error("User identification datas missing.");this[i]=e,this[a]=t;var o=JSON.stringify({opcode:"join",whoami:this[i],token:this[a]});this[s]&&this[s].readyState===r.OPEN?this[s].push(o):this[u].push(o)}},{key:"sendTo",value:function(e,t,o){if(!this[i]||!this[s])throw new Error("User identification required");var r={whoami:this[i],who:e,what:t};o&&(r.managed=!0),this[s].send("sendTo",r)}},{key:"broadcast",value:function(e,t){if(!this[i]||!this[s])throw new Error("User identification required");var o={whoami:this[i],who:"*",what:e};t&&(o.managed=!0),this[s].send("broadcast",o)}},{key:"whoAmI",get:function(){return this[i]}}]),n}(e.Observable);return l});
//# sourceMappingURL=comunicator-min.js.map