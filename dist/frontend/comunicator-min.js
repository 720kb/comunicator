!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/Rx"),require("ws")):"function"==typeof define&&define.amd?define("comunicator",["exports","rxjs/Rx","ws"],t):t(e.comunicator=e.comunicator||{},e.Rx,e.WebSocket)}(this,function(e,t,o){"use strict";t="default"in t?t["default"]:t,o="default"in o?o["default"]:o;var r={};r["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},r.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r.createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),r.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},r.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};var n=void 0;try{n=o,n||(n=window.WebSocket)}catch(i){n=window.WebSocket}var a=Symbol("whoReallyAmI"),s=Symbol("reallyToken"),c=Symbol("websocket"),u=Symbol("queue"),f=9e3,h=[0],l=function(){return Math.floor(Math.random()*(h.length+1))},p=function(e){function o(e){if(r.classCallCheck(this,o),!e)throw new Error("Mandatory parameter is missing: [websocketUrl] "+e);var i=new t.Observable(function(t){var o=!1;if(!a[c]||a[c].readyState===n.CONNECTING&&a[c].readyState===n.OPEN||(o=!0),"string"==typeof e)a[c]=new n(e);else{if(!("object"===("undefined"==typeof e?"undefined":r["typeof"](e))&&e instanceof n))throw new Error("websocket parameter passed is neither a string nor a WebSocket object");a[c]=e}return a[c].onopen=function(e){for(t.next({type:"open",whoami:e.target});a[u].length>0&&a[c].readyState===n.OPEN;)a[c].push(a[u].shift())},a[c].onmessage=function(e){var o=JSON.parse(e.data);"joined"===o.opcode?t.next({type:"joined",whoami:o.whoami}):"to-me"===o.opcode?t.next({type:"to-me",whoami:o.whoami,who:o.who,what:o.what}):"to-all"===o.opcode&&t.next({type:"to-all",whoami:o.whoami,what:o.what})},a[c].onerror=function(e){t.error({type:"error",cause:e})},a[c].onclose=function(){t.error({type:"closed"})},a[c].push=a[c].send,a[c].send=function(e,t){var o=JSON.stringify({opcode:e,token:a[s],data:t});a[c]&&a[c].readyState===n.OPEN?a[c].push(o):a[u].push(o)},o&&a[c].readyState!==n.CONNECTING&&a[c].readyState!==n.OPEN&&t.error({type:"closed"}),function(){a[c].close()}}).share(),a=r.possibleConstructorReturn(this,Object.getPrototypeOf(o).call(this,function(e){var o=i.retryWhen(function(e){return e.switchMap(function(){var e=f*(Math.pow(2,h.length)-1);return h.push(e),t.Observable.timer(h[l()])})}).subscribe(e);return function(){o.unsubscribe()}}));return a[u]=[],a}return r.inherits(o,e),r.createClass(o,[{key:"userIsPresent",value:function(e,t){if(this[a]===e&&this[s]===t)throw new Error("User is already identified.");if(!e||!t)throw new Error("User identification datas missing.");this[a]=e,this[s]=t;var o=JSON.stringify({opcode:"join",whoami:this[a],token:this[s]});this[c]&&this[c].readyState===n.OPEN?this[c].push(o):this[u].push(o)}},{key:"sendTo",value:function(e,t,o){if(!this[a]||!this[c])throw new Error("User identification required");var r={whoami:this[a],who:e,what:t};o&&(r.managed=!0),this[c].send("sendTo",r)}},{key:"broadcast",value:function(e,t){if(!this[a]||!this[c])throw new Error("User identification required");var o={whoami:this[a],who:"*",what:e};t&&(o.managed=!0),this[c].send("broadcast",o)}},{key:"whoAmI",get:function(){return this[a]}}]),o}(t.Observable);e.Comunicator=p});
//# sourceMappingURL=comunicator-min.js.map