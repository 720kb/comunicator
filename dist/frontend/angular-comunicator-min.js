!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("angular"),require("rxjs/Rx"),require("ws")):"function"==typeof define&&define.amd?define("angular-comunicator",["angular","rxjs/Rx","ws"],t):t(e.angular,e.Rx,e.WebSocket)}(this,function(e,t,o){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t,o="default"in o?o["default"]:o;var r={};r["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},r.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r.createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),r.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},r.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};var n=void 0;try{n=o,n||(n=window.WebSocket)}catch(i){n=window.WebSocket}var a=Symbol("whoReallyAmI"),s=Symbol("reallyToken"),u=Symbol("websocket"),c=Symbol("queue"),f=9e3,h=[0],l=function(){return Math.floor(Math.random()*(h.length+1))},d=function(e){function o(e){if(r.classCallCheck(this,o),!e)throw new Error("Mandatory parameter is missing: [websocketUrl] "+e);var i=new t.Observable(function(t){var o=!1;if(!a[u]||a[u].readyState===n.CONNECTING&&a[u].readyState===n.OPEN||(o=!0),"string"==typeof e)a[u]=new n(e);else{if(!("object"===("undefined"==typeof e?"undefined":r["typeof"](e))&&e instanceof n))throw new Error("websocket parameter passed is neither a string nor a WebSocket object");a[u]=e}return a[u].onopen=function(e){for(t.next({type:"open",whoami:e.target});a[c].length>0&&a[u].readyState===n.OPEN;)a[u].push(a[c].shift())},a[u].onmessage=function(e){var o=JSON.parse(e.data);"joined"===o.opcode?t.next({type:"joined",whoami:o.whoami}):"to-me"===o.opcode?t.next({type:"to-me",whoami:o.whoami,who:o.who,what:o.what}):"to-all"===o.opcode&&t.next({type:"to-all",whoami:o.whoami,what:o.what})},a[u].onerror=function(e){t.error({type:"error",cause:e})},a[u].onclose=function(){t.error({type:"closed"})},a[u].push=a[u].send,a[u].send=function(e,t){var o=JSON.stringify({opcode:e,token:a[s],data:t});a[u]&&a[u].readyState===n.OPEN?a[u].push(o):a[c].push(o)},o&&a[u].readyState!==n.CONNECTING&&a[u].readyState!==n.OPEN&&t.error({type:"closed"}),function(){a[u].close()}}).share(),a=r.possibleConstructorReturn(this,Object.getPrototypeOf(o).call(this,function(e){var o=i.retryWhen(function(e){return e.switchMap(function(){var e=f*(Math.pow(2,h.length)-1);return h.push(e),t.Observable.timer(h[l()])})}).subscribe(e);return function(){o.unsubscribe()}}));return a[c]=[],a}return r.inherits(o,e),r.createClass(o,[{key:"userIsPresent",value:function(e,t){if(this[a]===e&&this[s]===t)throw new Error("User is already identified.");if(!e||!t)throw new Error("User identification datas missing.");this[a]=e,this[s]=t;var o=JSON.stringify({opcode:"join",whoami:this[a],token:this[s]});this[u]&&this[u].readyState===n.OPEN?this[u].push(o):this[c].push(o)}},{key:"sendTo",value:function(e,t,o){if(!this[a]||!this[u])throw new Error("User identification required");var r={whoami:this[a],who:e,what:t};o&&(r.managed=!0),this[u].send("sendTo",r)}},{key:"broadcast",value:function(e,t){if(!this[a]||!this[u])throw new Error("User identification required");var o={whoami:this[a],who:"*",what:e};t&&(o.managed=!0),this[u].send("broadcast",o)}},{key:"whoAmI",get:function(){return this[a]}}]),o}(t.Observable);e.module("720kb.comunicator",[]).provider("Comunicator",function(){var e=void 0,t=function(t){return e=new d(t)};return{setComunicatorServerURL:t,$get:function(){return e}}})});
//# sourceMappingURL=angular-comunicator-min.js.map