{"version":3,"file":"comunicator.js","sources":["../../lib/frontend/comunicator.js"],"sourcesContent":["/*global window*/\nimport Rx from 'rxjs/Rx';\nimport WebSocket from 'ws';\nlet WebSocketCtor;\n\ntry {\n\n  WebSocketCtor = WebSocket;\n  if (!WebSocketCtor) {\n\n    WebSocketCtor = window.WebSocket;\n  }\n} catch (err) {\n\n  WebSocketCtor = window.WebSocket;\n}\n\nconst whoReallyAmISym = Symbol('whoReallyAmI')\n  , reallyTokenSym = Symbol('reallyToken')\n  , websocketSym = Symbol('websocket')\n  , queueSym = Symbol('queue')\n  , timeWaitSlice = 9000\n  , timeWaitSliceChoices = [0]\n  , giveMeATimeWait = () => {\n\n    return Math.floor(Math.random() * (timeWaitSliceChoices.length + 1));\n  };\n\nclass Comunicator extends Rx.Observable {\n  constructor(websocketUrl) {\n    if (!websocketUrl) {\n\n      throw new Error(`Mandatory parameter is missing: [websocketUrl] ${websocketUrl}`);\n    }\n\n    const internalObservable = new Rx.Observable(subscriber => {\n      let inError = false;\n\n      if (this[websocketSym] &&\n        (this[websocketSym].readyState !== WebSocketCtor.CONNECTING ||\n        this[websocketSym].readyState !== WebSocketCtor.OPEN)) {\n\n        inError = true;\n      }\n\n      if (typeof websocketUrl === 'string') {\n\n        this[websocketSym] = new WebSocketCtor(websocketUrl);\n      } else if (typeof websocketUrl === 'object' &&\n        websocketUrl instanceof WebSocketCtor) {\n\n        this[websocketSym] = websocketUrl;\n      } else {\n\n        throw new Error('websocket parameter passed is neither a string nor a WebSocket object');\n      }\n\n      this[websocketSym].onopen = event => {\n\n        subscriber.next({\n          'type': 'open',\n          'whoami': event.target\n        });\n\n        while (this[queueSym].length > 0 &&\n          this[websocketSym].readyState === WebSocketCtor.OPEN) {\n\n          this[websocketSym].push(this[queueSym].shift());\n        }\n      };\n\n      this[websocketSym].onmessage = event => {\n        const parsedMsg = JSON.parse(event.data);\n\n        if (parsedMsg.opcode === 'joined') {\n\n          subscriber.next({\n            'type': 'joined',\n            'whoami': parsedMsg.whoami\n          });\n        } else if (parsedMsg.opcode === 'to-me') {\n\n          subscriber.next({\n            'type': 'to-me',\n            'whoami': parsedMsg.whoami,\n            'who': parsedMsg.who,\n            'what': parsedMsg.what\n          });\n        } else if (parsedMsg.opcode === 'to-all') {\n\n          subscriber.next({\n            'type': 'to-all',\n            'whoami': parsedMsg.whoami,\n            'what': parsedMsg.what\n          });\n        }\n      };\n\n      this[websocketSym].onerror = error => {\n\n        subscriber.error({\n          'type': 'error',\n          'cause': error\n        });\n      };\n\n      this[websocketSym].onclose = () => {\n\n        subscriber.error({\n          'type': 'closed'\n        });\n      };\n\n      this[websocketSym].push = this[websocketSym].send;\n      this[websocketSym].send = (opcode, data) => {\n        const messageToSend = JSON.stringify({\n          opcode,\n          'token': this[reallyTokenSym],\n          data\n        });\n\n        if (this[websocketSym] &&\n          this[websocketSym].readyState === WebSocketCtor.OPEN) {\n\n          this[websocketSym].push(messageToSend);\n        } else {\n\n          this[queueSym].push(messageToSend);\n        }\n      };\n\n      if (inError &&\n        this[websocketSym].readyState !== WebSocketCtor.CONNECTING &&\n        this[websocketSym].readyState !== WebSocketCtor.OPEN) {\n\n        subscriber.error({\n          'type': 'closed'\n        });\n      }\n\n      return () => {\n\n        this[websocketSym].close();\n      };\n    }).share();\n\n    super(observer => {\n\n      const subscriptionToInternalObservable = internalObservable\n        .retryWhen(errors => errors.switchMap(() => {\n          const nextTimeWaitSliceChoice = timeWaitSlice * (Math.pow(2, timeWaitSliceChoices.length) - 1);\n\n          timeWaitSliceChoices.push(nextTimeWaitSliceChoice);\n          return Rx.Observable.timer(timeWaitSliceChoices[giveMeATimeWait()]);\n        }))\n        .subscribe(observer);\n\n      return () => {\n\n        subscriptionToInternalObservable.unsubscribe();\n      };\n    });\n\n    this[queueSym] = [];\n  }\n\n  userIsPresent(whoami, token) {\n\n    if (this[whoReallyAmISym] !== whoami ||\n      this[reallyTokenSym] !== token) {\n\n      if (whoami &&\n        token) {\n\n        this[whoReallyAmISym] = whoami;\n        this[reallyTokenSym] = token;\n\n        const joinMessage = JSON.stringify({\n          'opcode': 'join',\n          'whoami': this[whoReallyAmISym],\n          'token': this[reallyTokenSym]\n        });\n\n        if (this[websocketSym] &&\n          this[websocketSym].readyState === WebSocketCtor.OPEN) {\n\n          this[websocketSym].push(joinMessage);\n        } else {\n\n          this[queueSym].push(joinMessage);\n        }\n      } else {\n\n        throw new Error('User identification datas missing.');\n      }\n    } else {\n\n      throw new Error('User is already identified.');\n    }\n  }\n\n  sendTo(who, what, managed) {\n\n    if (this[whoReallyAmISym] &&\n      this[websocketSym]) {\n\n      const toSend = {\n        'whoami': this[whoReallyAmISym],\n        who,\n        what\n      };\n\n      if (managed) {\n\n        toSend.managed = true;\n      }\n\n      this[websocketSym].send('sendTo', toSend);\n    } else {\n\n      throw new Error('User identification required');\n    }\n  }\n\n  broadcast(what, managed) {\n\n    if (this[whoReallyAmISym] &&\n      this[websocketSym]) {\n\n      const toSend = {\n        'whoami': this[whoReallyAmISym],\n        'who': '*',\n        what\n      };\n\n      if (managed) {\n\n        toSend.managed = true;\n      }\n\n      this[websocketSym].send('broadcast', toSend);\n    } else {\n\n      throw new Error('User identification required');\n    }\n  }\n\n  get whoAmI() {\n\n    return this[whoReallyAmISym];\n  }\n}\n\nexport {Comunicator};\n"],"names":[],"mappings":"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"}