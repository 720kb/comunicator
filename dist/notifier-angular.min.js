/*
 * notifier - v0.0.1
 *
 * The 720kb notifier api (atm it uses websockets)
 * 2015-01-25
 */


!function(a,b){"use strict";a.module("720kb.notifier",[]).provider("Notifier",function(){var a,c,d=16,e=[0],f=function(){return Math.floor(Math.random()*(e.length+1))},g=function(c){c?(a=new b.WebSocket(c),a.onopen=function(){b.console.info("Trasport",this,"opened.")}):b.console.error("Please provide a valid URL."),a.push=a.send};return{setNotifierServerURL:g,$get:["$window","$rootScope","$timeout","$log","$q",function(b,h,i,j,k){c=k.defer();for(var l,m,n,o,p=function(c,g){var h,k;a.readyState===b.WebSocket.OPEN?a.push(JSON.stringify({opcode:c,token:n,data:g})):(h=d*(Math.pow(2,e.length)-1),e.push(h),k=f(),j.info("Trasport to server is not ready. Choosing between",e,"the value",k),i(a.send.apply(this,[c,g]),k))},q=function(a){var b=JSON.parse(a.data);"joined"===b.opcode?h.$emit("notifier:joined"):"sent"===b.opcode?h.$emit("notifier:toMe",b):"broadcasted"===b.opcode&&h.$emit("notifier:toAll",b)},r=function B(){a.readyState===b.WebSocket.OPEN?a.push(JSON.stringify({opcode:"join",whoami:m,token:n})):a.readyState===b.WebSocket.CLOSED?(g(a.url),a.send=p,a.onmessage=q,B()):(j.info("Trasport to server is not yet ready. Retry..."),b.requestAnimationFrame(B))},s=function(a,b){m=a,n=b,m&&n?r():j.error("User identification datas missing.")},t=function(b){if(m&&a){var c={whoami:m,who:"*",what:b};a.send("broadcast",c)}else j.error("User identification required")},u=function(b,c){if(m&&a){var d={whoami:m,who:b,what:c};a.send("sendTo",d)}else j.error("User identification required")},v=function(){a.readyState===b.WebSocket.OPEN&&a.close()},w=["$stateChangeSuccess","$routeChangeSuccess"],x=[],y=w.length,z=0,A=function(){for(var a=0,b=x.length;b>a;a+=1)x[a]();c.resolve({userIsPresent:s,broadcast:t,sendTo:u,exit:v})};y>z;z+=1)o=w[z],x.push(h.$on(o,A));return a||(l="Mandatory field notifierServerURL required",j.error(l,a),c.reject(l)),a.send=p,a.onmessage=q,c.promise}]}})}(angular,window);
//# sourceMappingURL=notifier-angular.min.js.map