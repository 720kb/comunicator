/*
 * notifier - v0.0.1
 *
 * The 720kb notifier api (atm it uses websockets)
 * 2015-01-25
 */


!function(){"use strict";for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;c+=1)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){window.clearTimeout(a)})}(),function(a,b){"use strict";a.module("720kb.notifier",[]).provider("Notifier",function(){var c,d,e=function(a){a?(c=new b.WebSocket(a),c.onopen=function(){b.console.info("Trasport",this,"opened.")}):b.console.error("Please provide a valid URL."),c.push=c.send};return{setNotifierServerURL:e,$get:["$window","$rootScope","$log","$q",function(b,f,g,h){d=h.defer();for(var i,j,k,l,m=function(a,d){c.readyState===b.WebSocket.OPEN?c.push(JSON.stringify({opcode:a,token:k,data:d})):(g.info("Trasport to server is not ready."),b.requestAnimationFrame(c.send.apply(this,[a,d])))},n=function(a){var b=JSON.parse(a.data);"joined"===b.opcode?f.$emit("notifier:joined"):"sent"===b.opcode?f.$emit("notifier:toMe",b):"broadcasted"===b.opcode&&f.$emit("notifier:toAll",b)},o=function y(){c.readyState===b.WebSocket.OPEN?c.push(JSON.stringify({opcode:"join",whoami:j,token:k})):c.readyState===b.WebSocket.CLOSED?(e(c.url),c.send=m,c.onmessage=n,y()):(g.info("Trasport to server is not yet ready. Retry..."),b.requestAnimationFrame(y))},p=function(a,b){j=a,k=b,j&&k?o():g.error("User identification datas missing.")},q=function(a){if(j&&c){var b={whoami:j,who:"*",what:a};c.send("broadcast",b)}else g.error("User identification required")},r=function(a,b){if(j&&c){var d={whoami:j,who:a,what:b};c.send("sendTo",d)}else g.error("User identification required")},s=function(){c.readyState===b.WebSocket.OPEN&&c.close()},t=["$stateChangeSuccess","$routeChangeSuccess"],u=[],v=t.length,w=0,x=function(b){d.resolve({userIsPresent:p,broadcast:q,sendTo:r,exit:s}),a.isUndefined(b)||u[b]()};v>w;w+=1)l=t[w],u.push(f.$on(l,x.bind(this,w)));return c||(i="Mandatory field notifierServerURL required",g.error(i,c),d.reject(i)),c.send=m,c.onmessage=n,d.promise}]}})}(angular,window);
//# sourceMappingURL=notifier-angular.min.js.map