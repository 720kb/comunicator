/*
 * comunicator - v1.1.4
 *
 * The 720kb notifier api (atm it uses websockets)
 * https://github.com/720kb/comunicator
 * MIT license
 * 2015-04-18T11:37:16.405Z
 */


!function(e){"use strict";var t=function(t){var i=function t(i,s){var n,o;this.chosenTimeWaitValue>0&&this.websocket.readyState!==e.WebSocket.OPEN?(this.chosenTimeWaitValue-=1,n=e.requestAnimationFrame(t.bind(this,i,s)),"send"===s?this.sendPendingRequests.push(n):this.joinPendingRequests.push(n)):(o=this.timeWaitSlice*(Math.pow(2,this.timeWaitSliceChoices.length)-1),this.timeWaitSliceChoices.push(o),this.chosenTimeWaitValue=this.giveMeATimeWait(),i())};this.timeWaitSlice=9e3,this.timeWaitSliceChoices=[0],this.chosenTimeWaitValue=0,this.sendPendingRequests=[],this.joinPendingRequests=[],this.giveMeATimeWait=function(){return Math.floor(Math.random()*(this.timeWaitSliceChoices.length+1))},this._doJoin=function(){var t,s,n,o=i.bind(this,this._doJoin.bind(this),"join"),h=0;if(this.websocket.readyState===e.WebSocket.OPEN){for(this.websocket.push(JSON.stringify({opcode:"join",whoami:this.whoReallyAmI,token:this.reallyToken})),h=0,s=this.joinPendingRequests.length;s>h;h+=1)n=this.joinPendingRequests[h],e.cancelAnimationFrame(n);this.joinPendingRequests=[]}else this.websocket.readyState===e.WebSocket.CONNECTING?(t=e.requestAnimationFrame(o),this.joinPendingRequests.push(t)):(this.initComunicator(this.websocket.url),this.websocket.send=this.sendMessage.bind(this),this.websocket.onmessage=this.onWebsocketMessage.bind(this),this.websocket.onclose=this.onWebsocketClose.bind(this),t=e.requestAnimationFrame(o),this.joinPendingRequests.push(t))},this.onWebsocketMessage=function(t){var i,s=e.JSON.parse(t.data);if("joined"===s.opcode?i=new e.CustomEvent("comunicator:joined"):"sent"===s.opcode?i=new e.CustomEvent("comunicator:to-me",{detail:s}):"broadcasted"===s.opcode&&(i=new e.CustomEvent("comunicator:to-all",{detail:s})),!i)throw"Operation code from comunicator not reconized";e.dispatchEvent(i)},this.onWebsocketClose=function(){this.whoReallyAmI&&this.reallyToken&&(e.dispatchEvent(new e.CustomEvent("comunicator:closed")),(this.websocket.readyState!==e.WebSocket.OPEN||this.websocket.readyState!==e.WebSocket.CONNECTING)&&this._doJoin())},this.sendMessage=function(t,s){var n,o,h,a=i.bind(this,this.sendMessage.bind(this,t,s),"send"),c=0;if(this.websocket.readyState===e.WebSocket.OPEN){for(this.websocket.push(JSON.stringify({opcode:t,token:this.reallyToken,data:s})),c=0,o=this.sendPendingRequests.length;o>c;c+=1)h=this.sendPendingRequests[c],e.cancelAnimationFrame(h);this.sendPendingRequests=[]}else n=e.requestAnimationFrame(a),this.sendPendingRequests.push(n)},this.initComunicator=function(t){if(!t)throw"Please provide a valid URL.";this.websocket=new e.WebSocket(t),this.websocket.onopen=function(){e.console.info("Trasport",this,"opened.")},this.websocket.push=this.websocket.send,this.websocket.send=this.sendMessage.bind(this),this.websocket.onmessage=this.onWebsocketMessage.bind(this),this.websocket.onclose=this.onWebsocketClose.bind(this)},this.initComunicator(t)};t.prototype.promise=function(t){if(!this.websocket)throw"Mandatory field comunicatorServerURL required";if(t&&Array.isArray(t)){var i=function(i){var s,n,o=t.length,h=function(t,i){if(this.whoReallyAmI!==t||this.reallyToken!==i){if(this.whoReallyAmI=t,this.reallyToken=i,!this.whoReallyAmI||!this.reallyToken)throw"User identification datas missing.";this._doJoin()}else e.console.info("User is already identified.")},a=function(e){if(!this.whoReallyAmI||!this.websocket)throw"User identification required";var t={whoami:this.whoReallyAmI,who:"*",what:e};this.websocket.send("broadcast",t)},c=function(e,t){if(!this.whoReallyAmI||!this.websocket)throw"User identification required";var i={whoami:this.whoReallyAmI,who:e,what:t};this.websocket.send("sendTo",i)},d=function(){this.websocket.readyState===e.WebSocket.OPEN&&this.websocket.close()},r=function r(){for(s=0;o>s;s+=1)n=t[s],n&&e.removeEventListener(n,r,!1);i({userIsPresent:h.bind(this),broadcast:a.bind(this),sendTo:c.bind(this),exit:d.bind(this)})};for(s=0;o>s;s+=1)n=t[s],n&&e.addEventListener(n,r.bind(this),!1)};return new Promise(i.bind(this))}throw"events must be defined and must be an array"},e.Comunicator=t}(window);
//# sourceMappingURL=comunicator.min.js.map