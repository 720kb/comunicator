/*
 * notifier - v0.0.1
 *
 * The 720kb notifier api (atm it uses websockets)
 * 2014-11-05
 */


!function(a,b,c,d){"use strict";var e=b("ws"),f=b("jsonwebtoken"),g=b("events").EventEmitter,h=c.env.NOTIFER_HOST||"0.0.0.0",i=c.env.NOTIFER_PORT||9876,j={},k=e.Server,l=new k({host:h,port:i},function(){d.info("Server listen websocket connections on host - port:",h,"-",i)});a.exports=function(a){var b=new g,c=function(a,b){var c,d,f,g={opcode:"broadcasted",whoami:a,what:b},h=Object.keys(j);for(c=0;c<h.length;c+=1)d=h[c],f=j[d],f.readyState===e.OPEN&&f.send(JSON.stringify(g))},h=function(a,b,c){var f={opcode:"sent",whoami:a,who:b,what:c},g=j[b];g&&g.readyState===e.OPEN?g.send(JSON.stringify(f)):d.error("No user",b,"is connected to notifier")},i=function(a){return void 0!==j[a]},k=function(e,g){var i=JSON.parse(e);d.log("Incoming message:",i),"join"===i.opcode?f.verify(i.token,a,function(){b.emit("notifier:userJoin",i.whoami),j[i.whoami]=g;var a={opcode:"joined",whoami:i.whoami,token:i.token};g.send(JSON.stringify(a))}):"sendTo"===i.opcode&&i.data&&i.data.who&&i.data.whoami&&i.data.what?f.verify(i.token,a,function(){h(i.data.whoami,i.data.who,i.data.what)}):"broadcast"===i.opcode&&i.data&&i.data.whoami&&i.data.what&&f.verify(i.token,a,function(){c(i.data.whoami,i.data.what)})},m=function(a){var c,d,e=Object.keys(j);for(c=0;c<e.length;c+=1)d=e[c],a===j[d]&&(b.emit("notifier:userLeave",d),delete j[d])},n=function(a){a.on("message",function(b){k(b,a)}),a.on("close",function(){m(a)})};return l.on("connection",n),b.broadcast=c,b.sendTo=h,b.isUserPresent=i,b}}(module,require,process,console);
//# sourceMappingURL=notifier-node.min.js.map